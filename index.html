<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Football Scene Viewer</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #renderCanvas {
            width: 100%;
            height: 100%;
        }
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-family: Arial, sans-serif;
            z-index: 1000;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>
<body>
    <div id="loadingScreen">
        <div class="spinner"></div>
        <div>Loading...</div>
    </div>
    <canvas id="renderCanvas"></canvas>
    <script>
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        BABYLON.Database.IDBStorageEnabled = true;
        engine.enableOfflineSupport = true;
        const loadingScreen = document.getElementById("loadingScreen");

        const createScene = async function() {
            const scene = new BABYLON.Scene(engine);
            
            // Настройка камеры
            const camera = new BABYLON.ArcRotateCamera("camera", 0, Math.PI / 3, 10, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            camera.lowerRadiusLimit = 5;
            camera.upperRadiusLimit = 80;

            // Добавление освещения
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;

            // Создание неба
            const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size: 1000.0}, scene);
            const skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("https://assets.babylonjs.com/textures/TropicalSunnyDay", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skybox.material = skyboxMaterial;
            
            // 1. Загрузка .env текстуры (HDR окружение)
            const envTexture = BABYLON.CubeTexture.CreateFromPrefilteredData(
                "https://assets.babylonjs.com/environments/studio.env",
                scene
            );
            
            // 2. Установка параметров
            envTexture.coordinatesMode = BABYLON.Texture.SPHERICAL_MODE; // 3 == SPHERICAL_MODE
            envTexture.lodGenerationScale = 0.8;
            envTexture.lodGenerationOffset = 0;
            envTexture.level = 1;
            envTexture.rotationY = 0; // ориентация освещения
            
            // 3. Назначение HDR окружения в сцену
            scene.environmentTexture = envTexture;
            scene.environmentIntensity = 1; // глобальная яркость environment света
            
            if (new URLSearchParams(window.location.search).has("DEBUG")) {
                scene.debugLayer.show();
            }

            // Загрузка модели
            try {
                const result = await BABYLON.SceneLoader.ImportMeshAsync("", "./", "football2.glb", scene);
                const model = result.meshes[0];
                
                // Получаем список анимаций
                const animations = result.animationGroups;
                if (animations && animations.length > 0) {
                    // Запускаем все анимации
                    animations.forEach(animation => {
                        animation.play(true);
                    });
                }
                
                // Центрирование модели
                const boundingInfo = model.getHierarchyBoundingVectors();
                const center = boundingInfo.min.add(boundingInfo.max).scale(0.5);
                model.position = center.scale(-1);
                
                // Автоматическая настройка камеры под размер модели
                const radius = boundingInfo.max.subtract(boundingInfo.min).length() * 0.5;
                camera.radius = radius * 2;
                
                screen4 = scene.getMaterialByName("screen.4");
                screen5 = scene.getMaterialByName("screen.5");
                screen4.needDepthPrePass = true;
                screen5.needDepthPrePass = true;
                
                screen4aMesh = scene.getMeshByName("screen_4");
                screen4bMesh = scene.getMeshByName("R_Tunnel_LED");
                screen4aMesh.position = new BABYLON.Vector3(518.0243530273438, -1350, 501.41876220703125);
                screen4aMesh.rotationQuaternion = new BABYLON.Quaternion(0, 0, 0.9961946980917455, -0.08715574274765824);
                screen4bMesh.position = new BABYLON.Vector3(518.0243530273438, -1350.04, 501.41876220703125);// (debugNode as BABYLON.Mesh)
                screen4bMesh.rotationQuaternion = new BABYLON.Quaternion(0, 0, 0.9961946980917455, -0.08715574274765824);// (debugNode as BABYLON.Mesh)
                
                screen5aMesh = scene.getMeshByName("screen_5");
                screen5bMesh = scene.getMeshByName("R_Tunnel_LED.001");
                screen5aMesh.position = new BABYLON.Vector3(518.0243530273438, 1434.703, 500.6176452636719);// (debugNode as BABYLON.Mesh)
                screen5aMesh.rotationQuaternion = new BABYLON.Quaternion(0, 0, -0.08715574274765815, 0.9961946980917455);// (debugNode as BABYLON.Mesh)
                screen5bMesh.position = new BABYLON.Vector3(518.0243530273438, 1434.703, 500.6176452636719);// (debugNode as BABYLON.Mesh)
                screen5bMesh.rotationQuaternion = new BABYLON.Quaternion(0, 0, -0.08715574274765817, 0.9961946980917455);// (debugNode as BABYLON.Mesh)
                
                // Скрываем спиннер после загрузки
                loadingScreen.style.display = "none";
            } catch (error) {
                console.error("Ошибка при загрузке модели:", error);
                loadingScreen.innerHTML = `<div style="color: red;">Ошибка загрузки модели: ${error.message}</div>`;
            }

            return scene;
        }

        createScene().then(scene => {
            engine.runRenderLoop(function() {
                scene.render();
            });
        });

        window.addEventListener("resize", function() {
            engine.resize();
        });
    </script>
</body>
</html> 